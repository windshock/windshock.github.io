# Bypassing Citrix policy is not a vulnerability, but it can be a violation of the law.

## Note!!

As a result of discussions with Citrix using [VINCE](https://kb.cert.org/vince/comm/case/1022/) from cert.org, it was concluded that this is not a vulnerability(because os administrative privileges are required), so I can share this information without any concerns. For security reasons, I do not recommend using Xendesktop (VDI) in special environments such as logical network isolation or closed networks for security. If it must be used, please remove administrator privileges and make sure to install security-specific programs.

## Description

The Citrix VDI Agent(PicaSvc2.exe) seems to have a structure in which it receives policies from the Citrix management server, records them in the registry(HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\), and reads the policies from the registry to reflect the policies to the user's VDI. An attacker can bypass the Drive, Network, Clipboard, etc. security policies issued by the Citrix Policy Server through registry manipulation.  (poc 참조)

Citrix의 CC 인증 문서(http://www.citrix.com/about/legal/security-compliance/common-criteria.html)를 참고하면 공격자에 의한 이러한 설정데이터(Configdata)의 수정을 방지하는 기능을 설계한 것을 알 수 있습니다. 이러한 우회는 구현상의 오류로 판단할 수 있습니다. 

If a closed or isolated network environment must be used, bypassing Citrix Policy and forcibly connecting VDI to the internet can potentially expose the internal network to the internet and leak sensitive information to external parties. In Korea, this is a clear violation of the law and requires a re-evaluation of network isolation solutions or environments. 

## POC  
The attacker would have to be logged into the company's Citrix VDI(windows 10 os) after taking over the company's account. The VDI is in a state where network, printer, external hard write read, clipboard read and write, etc. are restricted.

1. The attacker logs into VDI and executes a Bat file ([https://windshock.github.io/bypass.zip](https://windshock.github.io/bypass.zip)) that continuously modifies the registry. Then, they close the VDI connection.  
  

Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User]

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\CdmPolicies]
"AutoConnectDrives"=dword:00000001
"AllowCdromDrives"=dword:00000001
"AllowFixedDrives"=dword:00000001
"AllowFloppyDrives"=dword:00000001
"AllowNetworkDrives"=dword:00000001
"AllowRemoveableDrives"=dword:00000001
"UseAsyncWrites"=dword:00000001
"ReadOnlyMappedDrive"=dword:00000000

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\IO]
"AutoConnectClientLptPorts"=dword:00000001
"TryMapToClientDriveLetter"=dword:00000001
"AllowFileTransfer"=dword:00000001
"AllowFileUpload"=dword:00000001
"AllowFileDownload"=dword:00000001

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\VCPolicies]
"AllowComPortRedirection"=dword:00000001
"AllowDriveRedir"=dword:00000001
"AllowLptPortRedirection"=dword:00000001
"AllowPrinterRedir"=dword:00000001
"AllowClipboardRedir"=dword:00000001
"ReadonlyClipboard"=dword:00000001
"AllowUSBRedir"=dword:00000001
"RestrictSessionClipboardWrite"=dword:00000000
"RestrictClientClipboardWrite"=dword:00000000

2. When the attacker logs back into VDI, PicaSvc2.exe communicates with the Citrix server to receive policies and records the corresponding policies in the registry.  
  
3. While PicaSvc2.exe records and reads the policies, the registry's policy values are tampered with by the Bat file previously executed by the attacker.  
  
4. PicaSv2.exe reads the policies recorded in the registry (which were manipulated by the attacker) and reflects the manipulated policies on Windows.

5. 접속하는 pc의 registry를 변경하면 네트워크가 가능한 하드웨어의 리다이렉트가 가능하다.

6. citrix 기본 정책으로 [usb class FFh](https://www.usb.org/defined-class-codes#anchor_BaseClassFFh) 은 허용되므로 iphone 레더링, 혹은 usb 형태의 wireless card를 이용하면 Usb Redirect가 허용되므로 망분리 환경에서 인터넷으로 네트워크를 연결할 수 있다.

7. iphone 테더링을 위해서는 itunes 설치 파일에서 추출한 드라이버 2개([apple network driver](https://windshock.github.io/applenetworkdriver.zip), [apple usb driver](https://windshock.github.io/appleusbdriver.zip))를 설치해야 한다.

9. citrix 접속 화면에서 iphone을 다시 redirect하면 이제 망분리 환경에서 인터넷 사용이 가능하다.

## Impact
For companies that use VDI for logical network separation purposes, this vulnerability can lead to internal information leakage and intrusion of internal servers.

DiscoveryUse process  [monitor(https://learn.microsoft.com/en-us/sysintemonitor)](https//learn.microsoft.com/en-us/sysinternals/downloads/procmon))  to monitor the functionality of the citrix agent(PicaSvc2.exe).  
  
Check the registry that the citrix agent uses to store policy settings.  
  
View and manipulate the contents of that registry.

## 설계 분석
TOE(CC 평가 대상)에 Virtual Desktop/Application, VDA(Virtual Delivery Agent)가 포함되며,
공격자에 의한 Configdata의 수정을 방지하는 기능을 정의하지만

Citrix Common Criteria Certification Information - https://www.citrix.com/about/legal/security-compliance/common-criteria.html Summary of only Configdata content in XenApp-XenDesktop7-15LTSR-STv1-0.pdf

O.Secure_Setup_Data The confidentiality and integrity of data required for setup and assignment of a virtual desktop or published application must be maintained during processing and transmission between servers.

Attackers, application users and desktop users are prevented from modifying Configdata by a combination of TOE and environment objectives to apply authentication, authorisation, confidentiality and integrity.

O.Secure_Setup_Data, OE.TLS and OE.Encryption ensure the confidentiality and integrity of the Configdata on the servers and when transmitted between servers.

O.Secure_Setup_Data ensures the confidentiality and integrity of the setup and assignment data for the virtual desktop and published applications during transmission between servers.

O.Secure_Setup_Data - FMT_SMF.1/Authorise The TSF shall be capable of performing the following management functions: [  Administration of Endpoint data access control policy.]

Administration of the Endpoint data access control policy consists of enabling or disabling the following functions for published applications and virtual desktops: • cut and paste between a client clipboard and the clipboard in a published application or virtual desktop; • client drive mapping in a published application or virtual desktop; • access to User Device USB devices from virtual desktops.

-   FMT_MSA.1/Desktop
-   FMT_MSA.3/Desktop
-   FMT_MSA.1/Application
-   FMT_MSA.3/Application
-   FPT_ITT.1

## 법률 개선 필요 사항
금융위는 전자금융거래법 시행령과 감독규정 개정안에 따라 논리적 망분리에 대한 선택권을 부여하고 있으며(전자금융감독규정 제15조 해킹 등 방지대책 제1항3호, 이하 전금법), 정보통신서비스 제공자들은 정보통신망을 통해 악성코드에 감염되는 등 불법적인 접근을 차단하고 침해사고를 방지하기 위하여 망분리를 도입해야 합니다.

위와 같은 취약점은 공격자가 관리자 권한이 없다면 이용할 수 없습니다. 전통망법의 경우 논리적 망분리 대상 업무용 PC의 사용자 계정에 관리자 권한을 제거해야 한다는 규제를 추가할 필요가 있습니다.

또한, CC 인증 시에도 

## Limitation
관리자 권한 및 프로그램 설치 권한을 제한한다고 하더라도, 근본적으로 화면 이미지를 기반한 데이터 유출은 막을 수 없습니다.
https://www.tarlogic.com/blog/pentests-in-restricted-vdi-environments/

논리적 망분리 3가지 모델, 이기종 보안 소프트웨어와 상호 운영 필요 - https://koreascience.kr/article/JAKO202031064817799.pdf

## 관련 이슈
주요 시중은행들은 2011년 농협해킹 사태 이후 내외부망 분리를 추진해왔다.
개인정보의 분실·도난·유출·위조·변조 또는 훼손을 방지하고 개인정보의 안전성을 확보하기 위하여 망분리를 권고한다. - https://blogger.pe.kr/618, https://itwiki.kr/w/ISMS-P_%EC%9D%B8%EC%A6%9D_%EA%B8%B0%EC%A4%80_2.6.7.%EC%9D%B8%ED%84%B0%EB%84%B7_%EC%A0%91%EC%86%8D_%ED%86%B5%EC%A0%9C
citrix cc 인증 - http://www.bikorea.net/news/articleView.html?idxno=11295, http://www.citrix.com/about/legal/security-compliance/common-criteria.html



<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEzNzA2MDYyNzQsLTg2NTYxOTY4NywxND
I3ODg4Mzc2LC0xNTQ5NjY5MzQyLDEzMTQwMjg4MTAsMTM1MzIy
NDUsMTkyNTQ4Njc5MSwxOTkxMzUyMzI4LC0xMTI3MDA5NzMzLC
0xODI0NTE5OTk1XX0=
-->