<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDF Viewer (Single Page)</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: #0b0f14;
        color: #e5e7eb;
      }
      .bar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 10px 12px;
        background: rgba(17, 24, 39, 0.92);
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        backdrop-filter: blur(8px);
      }
      .btn {
        appearance: none;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.06);
        color: inherit;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .meta {
        margin-left: auto;
        font-variant-numeric: tabular-nums;
        opacity: 0.9;
      }
      .wrap {
        padding: 14px;
      }
      .stage {
        max-width: 1100px;
        margin: 0 auto;
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
        overflow: hidden;
        position: relative;
      }
      /* Tap zones for prev/next (mobile-friendly) */
      .tapzones {
        position: absolute;
        inset: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        z-index: 5;
        pointer-events: none; /* enabled via media query */
      }
      .tapzone {
        pointer-events: auto;
        background: transparent;
        border: none;
        padding: 0;
        margin: 0;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .tapzone:focus-visible {
        outline: 2px solid rgba(147, 197, 253, 0.9);
        outline-offset: -2px;
      }
      canvas {
        display: block;
        width: 100%;
        height: auto;
        background: #111827;
      }
      .hint {
        max-width: 1100px;
        margin: 10px auto 0;
        font-size: 12px;
        opacity: 0.8;
      }
      a {
        color: #93c5fd;
      }

      /* Mobile ergonomics: put controls at the bottom and add safe-area padding */
      @media (max-width: 640px) {
        body {
          padding-bottom: calc(56px + env(safe-area-inset-bottom));
        }
        .bar {
          position: fixed;
          top: auto;
          bottom: 0;
          left: 0;
          right: 0;
          border-top: 1px solid rgba(148, 163, 184, 0.25);
          border-bottom: none;
          padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
        }
        .btn {
          flex: 1 1 auto;
          padding: 10px 12px;
          font-size: 16px;
          border-radius: 10px;
        }
        .meta {
          margin-left: 0;
          min-width: 72px;
          text-align: center;
          opacity: 0.95;
        }
        .wrap {
          padding-bottom: calc(14px + 56px + env(safe-area-inset-bottom));
        }
        .tapzones {
          pointer-events: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="bar">
      <button class="btn" id="prev">Prev</button>
      <button class="btn" id="next">Next</button>
      <span class="meta"><span id="page">1</span> / <span id="pages">?</span></span>
    </div>

    <div class="wrap">
      <div class="stage">
        <div class="tapzones" aria-hidden="true">
          <button class="tapzone" id="tap-prev" aria-label="Previous page (tap left side)"></button>
          <button class="tapzone" id="tap-next" aria-label="Next page (tap right side)"></button>
        </div>
        <canvas id="canvas"></canvas>
      </div>
      <div class="hint">
        If rendering fails, open the PDF directly: <a id="direct" href="#" target="_blank" rel="noopener">PDF</a>
      </div>
    </div>

    <script type="module">
      import * as pdfjsLib from "./build/pdf.mjs";

      // Use local worker
      pdfjsLib.GlobalWorkerOptions.workerSrc = "./build/pdf.worker.mjs";

      const params = new URLSearchParams(location.search);
      const file = params.get("file");
      if (!file) {
        document.body.innerHTML = "<div style='padding:16px'>Missing <code>?file=</code> parameter.</div>";
        throw new Error("Missing file param");
      }

      const direct = document.getElementById("direct");
      direct.href = file;

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");
      const tapPrevBtn = document.getElementById("tap-prev");
      const tapNextBtn = document.getElementById("tap-next");
      const pageEl = document.getElementById("page");
      const pagesEl = document.getElementById("pages");

      let pdfDoc = null;
      let pageNum = 1;
      let rendering = false;
      let pendingPage = null;
      let lastViewportHeight = null;

      function getInitialPageFromHash() {
        const hash = new URLSearchParams(location.hash.replace(/^#/, ""));
        const p = Number(hash.get("page") || "1");
        return Number.isFinite(p) && p >= 1 ? Math.floor(p) : 1;
      }

      function updateButtons() {
        prevBtn.disabled = pageNum <= 1;
        nextBtn.disabled = pdfDoc ? pageNum >= pdfDoc.numPages : true;
      }

      function computeScale(viewport) {
        const stage = canvas.parentElement;
        const stageWidth = stage.clientWidth;
        return stageWidth / viewport.width;
      }

      function adjustIframeHeight(contentHeightPx) {
        // Same-origin: allow the embedded viewer to resize its own iframe.
        const frame = window.frameElement;
        // NOTE: On some mobile browsers (notably iOS Safari), direct iframe resizing can be flaky.
        // We'll try direct resize first, but also postMessage the desired height to the parent,
        // so the parent document can set the iframe height reliably.

        const bar = document.querySelector(".bar");
        const hint = document.querySelector(".hint");

        const barH = bar ? bar.offsetHeight : 0;
        const hintH = hint ? hint.offsetHeight : 0;

        // wrap padding(14*2) + stage border/margins (~8) + hint spacing (~10)
        let desired = Math.ceil(barH + 14 + contentHeightPx + 14 + 8 + 10 + hintH);

        // Clamp to something comfortable relative to viewport, but never too small.
        let maxH = 980;
        try {
          if (window.parent && window.parent.innerHeight) {
            maxH = Math.floor(window.parent.innerHeight * 0.88);
          }
        } catch {}

        const minH = 420;
        desired = Math.max(minH, Math.min(desired, maxH));

        try {
          if (frame) frame.style.height = `${desired}px`;
        } catch {}

        try {
          window.parent?.postMessage(
            {
              type: "pdfjs-resize",
              height: desired,
              file,
            },
            "*",
          );
        } catch {}
      }

      async function renderPage(num) {
        rendering = true;
        const page = await pdfDoc.getPage(num);

        // Render at a scale that matches container width.
        const baseViewport = page.getViewport({ scale: 1.0 });
        const scale = computeScale(baseViewport);
        const viewport = page.getViewport({ scale });

        // HiDPI support
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(viewport.width * dpr);
        canvas.height = Math.floor(viewport.height * dpr);
        canvas.style.width = `${viewport.width}px`;
        canvas.style.height = `${viewport.height}px`;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        await page.render({ canvasContext: ctx, viewport }).promise;

        pageEl.textContent = String(pageNum);
        pagesEl.textContent = String(pdfDoc.numPages);
        updateButtons();

        lastViewportHeight = viewport.height;
        adjustIframeHeight(viewport.height);

        rendering = false;
        if (pendingPage !== null) {
          const n = pendingPage;
          pendingPage = null;
          await renderPage(n);
        }
      }

      function queueRender(num) {
        if (rendering) {
          pendingPage = num;
        } else {
          renderPage(num);
        }
      }

      function goPrev() {
        if (pageNum <= 1) return;
        pageNum -= 1;
        queueRender(pageNum);
      }

      function goNext() {
        if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
        pageNum += 1;
        queueRender(pageNum);
      }

      prevBtn.addEventListener("click", goPrev);
      nextBtn.addEventListener("click", goNext);

      // Tap-to-navigate zones (especially helpful on mobile):
      // Only treat as navigation if it looks like a quick tap (not a swipe).
      function attachTapNav(el, dir) {
        if (!el) return;
        let startX = null;
        let startY = null;
        let startT = 0;
        el.addEventListener(
          "touchstart",
          (e) => {
            const t = e.changedTouches && e.changedTouches[0];
            if (!t) return;
            startX = t.clientX;
            startY = t.clientY;
            startT = Date.now();
          },
          { passive: true },
        );
        el.addEventListener(
          "touchend",
          (e) => {
            const t = e.changedTouches && e.changedTouches[0];
            if (!t || startX === null || startY === null) return;
            const dx = t.clientX - startX;
            const dy = t.clientY - startY;
            const dt = Date.now() - startT;
            startX = null;
            startY = null;
            if (dt > 350) return;
            if (Math.abs(dx) > 18 || Math.abs(dy) > 18) return;
            if (dir === "prev") goPrev();
            else goNext();
          },
          { passive: true },
        );
        // Desktop click
        el.addEventListener("click", () => (dir === "prev" ? goPrev() : goNext()));
      }
      attachTapNav(tapPrevBtn, "prev");
      attachTapNav(tapNextBtn, "next");

      // Touch gestures (mobile): swipe left/right to change pages.
      let touchStartX = null;
      let touchStartY = null;
      let touchStartT = 0;

      function onTouchStart(e) {
        const t = e.changedTouches && e.changedTouches[0];
        if (!t) return;
        touchStartX = t.clientX;
        touchStartY = t.clientY;
        touchStartT = Date.now();
      }

      function onTouchEnd(e) {
        const t = e.changedTouches && e.changedTouches[0];
        if (!t || touchStartX === null || touchStartY === null) return;

        const dx = t.clientX - touchStartX;
        const dy = t.clientY - touchStartY;
        const dt = Date.now() - touchStartT;

        touchStartX = null;
        touchStartY = null;

        // Ignore slow drags; focus on quick horizontal swipes.
        if (dt > 700) return;
        if (Math.abs(dx) < 60) return;
        if (Math.abs(dy) > 80) return;

        if (dx < 0) goNext();
        else goPrev();
      }

      // Attach swipe to stage (so user can swipe anywhere on the PDF area).
      const stage = canvas.parentElement;
      stage.addEventListener("touchstart", onTouchStart, { passive: true });
      stage.addEventListener("touchend", onTouchEnd, { passive: true });

      // Re-render on resize to keep width-fit
      const ro = new ResizeObserver(() => queueRender(pageNum));
      ro.observe(canvas.parentElement);

      // As a fallback, adjust iframe height even before a re-render completes.
      window.addEventListener("resize", () => {
        if (lastViewportHeight) adjustIframeHeight(lastViewportHeight);
      });

      pageNum = getInitialPageFromHash();
      pdfDoc = await pdfjsLib.getDocument(file).promise;
      if (pageNum > pdfDoc.numPages) pageNum = pdfDoc.numPages;
      updateButtons();
      await renderPage(pageNum);
    </script>
  </body>
</html>


